<!DOCTYPE html>
<html>
<head>
    <title>Production Site Debug</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .log { margin: 5px 0; padding: 5px; background: #f0f0f0; }
        .error { background: #ffdddd; }
        .success { background: #ddffdd; }
        .info { background: #ddddff; }
    </style>
</head>
<body>
    <h1>ClearHold Production Debug</h1>
    <div id="logs"></div>
    
    <script>
        const logs = document.getElementById('logs');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toISOString()}] ${message}`;
            logs.appendChild(div);
            console.log(message);
        }
        
        async function debugSite() {
            log('Starting production site debug...', 'info');
            
            // Test 1: Fetch the main page and look for API configuration
            try {
                log('Fetching main page...', 'info');
                const response = await fetch('https://www.clearhold.app');
                const html = await response.text();
                
                // Look for environment variables in the HTML
                const envMatches = html.match(/NEXT_PUBLIC_[A-Z_]+/g) || [];
                log(`Found environment variable references: ${envMatches.join(', ') || 'none'}`, 'info');
                
                // Look for API URLs
                const apiUrlMatches = html.match(/https?:\/\/[^"'\s]*api[^"'\s]*/gi) || [];
                log(`Found API URLs: ${apiUrlMatches.join(', ') || 'none'}`, 'info');
                
                // Look for ngrok URLs
                const ngrokMatches = html.match(/https?:\/\/[^"'\s]*ngrok[^"'\s]*/gi) || [];
                log(`Found ngrok URLs: ${ngrokMatches.join(', ') || 'none'}`, ngrokMatches.length > 0 ? 'success' : 'error');
                
            } catch (error) {
                log(`Failed to fetch main page: ${error.message}`, 'error');
            }
            
            // Test 2: Try to load the actual JavaScript bundles
            try {
                log('Checking JavaScript bundles...', 'info');
                
                // Get the main chunk
                const mainResponse = await fetch('https://www.clearhold.app/_next/static/chunks/main-app-61f991908bebf9d6.js');
                if (mainResponse.ok) {
                    const mainJs = await mainResponse.text();
                    
                    // Search for API configuration
                    const apiConfigMatch = mainJs.match(/NEXT_PUBLIC_API_URL[^,;}]*/);
                    if (apiConfigMatch) {
                        log(`Found API config in main bundle: ${apiConfigMatch[0]}`, 'success');
                    }
                    
                    // Search for hardcoded API URLs
                    const hardcodedApis = mainJs.match(/["']https?:\/\/[^"']*api[^"']*/gi) || [];
                    if (hardcodedApis.length > 0) {
                        log(`Found hardcoded APIs: ${hardcodedApis.slice(0, 3).join(', ')}...`, 'info');
                    }
                }
            } catch (error) {
                log(`Failed to check JS bundles: ${error.message}`, 'error');
            }
            
            // Test 3: Check if we can access the API directly
            const ngrokUrl = 'https://1f2561dafffa.ngrok-free.app';
            try {
                log(`Testing direct API access to ${ngrokUrl}...`, 'info');
                
                const healthResponse = await fetch(`${ngrokUrl}/health`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                
                if (healthResponse.ok) {
                    const health = await healthResponse.json();
                    log(`API is accessible: ${JSON.stringify(health)}`, 'success');
                } else {
                    log(`API returned status ${healthResponse.status}`, 'error');
                }
            } catch (error) {
                log(`Failed to access API: ${error.message}`, 'error');
            }
            
            // Test 4: Check CORS
            try {
                log('Testing CORS from this origin...', 'info');
                
                const corsResponse = await fetch(`${ngrokUrl}/health`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'GET',
                        'Access-Control-Request-Headers': 'Content-Type,Authorization,ngrok-skip-browser-warning'
                    }
                });
                
                log(`CORS preflight status: ${corsResponse.status}`, corsResponse.status === 204 ? 'success' : 'error');
                log(`Allow-Origin: ${corsResponse.headers.get('Access-Control-Allow-Origin')}`, 'info');
                log(`Allow-Headers: ${corsResponse.headers.get('Access-Control-Allow-Headers')}`, 'info');
            } catch (error) {
                log(`CORS test failed: ${error.message}`, 'error');
            }
            
            // Test 5: Try to simulate what the auth context does
            try {
                log('Simulating auth context health check...', 'info');
                
                // This is what the auth context should be doing
                const authHealthResponse = await fetch(`${ngrokUrl}/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    signal: AbortSignal.timeout(3000)
                });
                
                if (authHealthResponse.ok) {
                    log('Auth context health check would succeed', 'success');
                } else {
                    log(`Auth context health check would fail with status ${authHealthResponse.status}`, 'error');
                }
            } catch (error) {
                log(`Auth context health check error: ${error.message}`, 'error');
            }
            
            log('Debug complete. Check console for detailed output.', 'info');
        }
        
        // Run the debug
        debugSite();
    </script>
</body>
</html>